---
  name: playwright-automation
  on:
    push:
      branches:
        - main
    schedule:
      - cron: 45 9 * * *
      - cron: 50 9 * * *
  jobs:
    build:
      name: Run end-to-end tests
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
          with:
            fetch-depth: 0
        - uses: actions/setup-node@v3
          with:
            node-version: "20"
        - name: install dependencies
          run: npm ci
        - name: install playwright
          run: npm install @playwright/test
        - name: run test environment
          env:
            test_env: test
          run: npx playwright test --project=chrome
        - uses: actions/upload-artifact@v2
          if: always()
          with:
            name: playwright-report
            path: playwright-report/
            retention-days: 30
        - name: Download zipped HTML report
          uses: actions/download-artifact@v2
          with:
            name: playwright-report
            path: playwright-report/
        - name: Notify Slack on failure
          uses: slackapi/slack-github-action@v1.23.0
          if: ${{ failure() }}
          env:
            SLACK_BOT_TOKEN: ${{secrets.SLACK_WEBHOOK_URL}}
          with:
            channel-id: ${{secrets.SLACK_CHANNEL_ID}}
            payload:    |
                      {
                        "text": "End to end test has failed",
                        "blocks": [
                          {
                            "type": "header",
                            "text": {
                              "type": "plain_text",
                              "text": ":bangbang: End to end test has failed",
                              "emoji": true
                            }
                          },
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "@here"
                            }
                          },
                          {
                            "type": "context",
                            "elements": [
                              {
                                "type": "mrkdwn",
                                "text": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                              }
                            ]
                          }
                        ]
                      }
  
